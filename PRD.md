# 产品需求文档：Rigel 实时网络流量调度系统 - V1.1

## 1. 修订历史
| 版本号 | 修订日期   | 修订人 | 修订内容 |
| ------ | ---------- | ------ | -------- |
| V1.0   | 2025-7-15 | 陈闯  | 基于学术论文资料创建初稿。 |
| V1.1   | 2025-7-28 | 陈闯  | 根据“逐块决策、整路下发”的新流程，重构核心工作流、组件职责和相关功能点，明确了Client模块的角色。 |

## 2. 项目背景与目标
### 2.1 核心问题
在现代多云（Multi-Cloud）和异构网络环境下，传统的网络流量调度系统面临巨大挑战。它们难以应对实时变化的流量需求和不稳定的网络状况，导致吞吐量低、延迟高、资源利用率不足。现有工具对于纯粹的流量转发场景过于笨重，且无法实现跨服务商的智能路由优化。

本项目旨在开发 **Rigel** 系统，一个分布式的、实时的网络流量调度系统，以解决上述问题。

### 2.2 需求目标
1.  **提升传输性能**: 在复杂的云网络中，实现高吞吐量、低成本的数据传输。
2.  **增强系统鲁棒性**: 能够实时适应网络环境的动态变化（如拥塞、链路质量波动），动态规划最优传输路径。
3.  **实现资源弹性**: 能够根据实时网络负载，自动伸缩云端代理节点资源，以最低成本应对流量高峰。
4.  **保证系统可扩展性**: 采用分布式架构，确保系统性能可以随着节点数量的增加而线性扩展，避免中心化瓶颈。

## 3. 核心组件与角色
### 3.1 Client 模块
*   **部署位置**: 部署在发送方（Sender）主机上，作为 Rigel 系统的入口。
*   **核心职责**:
    1.  作为数据传输任务的发起者，将大文件拆分为标准大小的数据块。
    2.  负责为待发送的**每一个数据块**向网络中的决策节点请求路由。
    3.  将获取到的**完整路径**和**数据块内容**进行封装。
    4.  根据获取到的**传输速率**指令，控制本地的发送行为（速率限制）。

### 3.2 代理节点 (ProxyAgent)
*   **部署位置**: 构成 Rigel 网络的核心基础设施节点，部署在全球各地的云服务器上。
*   **核心职责**:
    1.  **数据平面**: 作为一个高效的、被动的**执行者**。根据数据块头部封装的路径信息，进行“傻瓜式”的接力转发。
    2.  **控制平面**: 作为一个分布式的**决策者**。运行控制平面模块，响应 Client 的路由请求，并参与全网状态同步。

## 4. 系统工作流程详述
本系统采用“逐块决策、整路下发、分段执行”的动态路由模型。

1.  **背景任务：全网状态同步**
    *   每个代理节点上的控制平面模块，持续地向其所在区域的组长节点（手动指定）上报自身状态（如负载、链路质量、虚拟队列状态等）。
    *   组长节点之间互相交换汇总后的区域信息。
    *   组长节点再将全局信息同步给区域内的所有节点。
    *   **最终结果**: 每个代理节点都拥有一份准实时的、相同的全局网络状态“地图”，为其路径计算提供数据基础。

2.  **核心任务：单个数据块的传输（循环执行）**
    *   **Step 1: 请求决策**: Sender 上的 **Client 模块**为待发送的单个数据块，选择一个代理节点（例如通过延迟探测选择最近的）作为决策点，并发起路由请求。请求中包含任务目的地等元数据。
    *   **Step 2: 路径与速率计算**: 被选中的代理节点上的 **`TrafficScheduler`** 模块，利用其本地的全局网络“地图”，执行基于UMW框架的优化算法，计算出一条**完整的、端到端的转发路径**和**建议的最优传输速率**。
    *   **Step 3: 返回决策**: 决策节点将计算出的“完整路径”和“传输速率”返回给 Client 模块。
    *   **Step 4: 封装与发送**: **Client 模块**将“完整路径”封装进数据块的头部，并根据“传输速率”指令配置本地的速率控制器（如令牌桶），然后将数据块发送给路径的第一个代理节点。
    *   **Step 5: 接力转发**: 路径上的每个代理节点，只需解析数据块头部的路径信息，确定下一跳地址，然后进行转发。此过程极其轻量，不涉及任何本地决策或外部查询。
    *   **Step 6: 循环**: Client 模块为下一个数据块重复从 Step 1 开始的整个流程，从而为每个数据块获取基于最新网络状况的独立路由。

## 5. 功能需求详述

### 5.1 功能模块一：Client 模块
#### 5.1.1 功能点：路由决策请求
*   **作为** 任务发起者，
*   **我希望** 能向指定的 Rigel 代理节点发起请求，
*   **以便于** 为每个待发送的数据块获取最优的转发路径和传输速率。
*   **业务规则与逻辑**:
    1.  Client 应能配置一个或多个决策节点的地址列表。
    2.  在发起请求时，应能从列表中选择一个决策节点（例如通过轮询或延迟探测）。
    3.  请求中需包含任务元数据（如最终目的地、任务优先级等）。
*   **验收标准**:
    1.  能够成功向代理节点发送路由请求并接收响应。
    2.  响应中包含结构化的路径信息（节点地址列表）和速率信息（如 bps）。

#### 5.1.2 功能点：数据封装与速率控制
*   **作为** 数据的发送端，
*   **我希望** 能将获取到的路径信息封装到数据块头部，并遵守获取到的速率指令，
*   **以便于** 让代理网络能正确转发数据，并避免造成网络拥塞。
*   **业务规则与逻辑**:
    1.  需定义清晰的数据块头部格式（应用层协议），用于存放有序的路径节点列表及其他元数据。
    2.  必须实现一个速率控制机制（如令牌桶），并能根据收到的指令动态调整其速率。
*   **验收标准**:
    1.  发送出的数据块头部包含正确的路径信息。
    2.  实际发送速率与指令速率的误差在可接受范围内（如5%）。

### 5.2 功能模块二：代理节点 - 控制平面
#### 5.2.1 功能点：分布式状态同步
*   **作为** Rigel 网络中的一员，
*   **我希望** 能参与两级（区域内、跨区域）状态同步机制，
*   **以便于** 获取并维护一份完整的、准实时的全局网络状态视图。
*   **业务规则与逻辑**:
    1.  实现向组长节点的周期性状态上报（包括本地链路的虚拟队列状态）。
    2.  实现从组长节点同步全局状态信息，并更新本地视图。
    3.  组长节点之间需实现P2P的信息交换。
*   **验收标准**:
    1.  任意节点的本地网络状态变化，能在指定的时间内（如2-3秒）反映到全网所有节点的全局视图中。

#### 5.2.2 功能点：路径与速率计算服务
*   **作为** 一个可被 Client 选择的决策节点，
*   **我希望** 能提供一个服务接口，接收路由请求，并基于本地的全局视图计算并返回最优路径和速率，
*   **以便于** 为 Client 的数据块传输提供决策支持。
*   **业务规则与逻辑**:
    1.  实现基于 UMW 和 Lyapunov 优化的算法（参考论文 Algorithm 4.1）。
    2.  算法输入为任务元数据和本地的全局网络状态。
    3.  算法输出为一条完整的、有序的节点路径和建议的传输速率 `a*k(t)`。
    4.  当网络拥塞导致所有路径成本过高时，算法应能返回一个接近于零的速率，实现隐式准入控制。
*   **验收标准**:
    1.  能够对外提供稳定的路由决策API。
    2.  在模拟的不同网络拥塞场景下，计算出的路径能有效避开拥堵点。

### 5.3 功能模块三：代理节点 - 数据平面
#### 5.3.1 功能点：基于路径的接力转发
*   **作为** 数据传输路径上的一个中继节点，
*   **我希望** 能高效地解析数据块头部的路径信息，并将其转发给路径中的下一个节点，
*   **以便于** 忠实地执行 Client 指定的转发任务。
*   **业务规则与逻辑**:
    1.  代理必须能从TCP流中解析出数据块的边界（Chunk Framing）。
    2.  代理必须能解析出头部封装的、有序的路径列表。
    3.  确定下一跳地址后，代理可以选择性地从路径列表中移除自身信息，再进行转发。
    4.  转发逻辑应极其轻量，不涉及任何本地决策或外部查询。
*   **验收标准**:
    1.  能够正确解析路径并转发到下一跳。
    2.  数据转发的延迟（Processing Delay）极低。

### 5.4 功能模块四：弹性伸缩
#### 5.4.1 功能点：拥塞感知的资源伸缩
*   **作为** 系统的资源管理者 (`ElasticController`)，
*   **我希望** 能够根据网络拥塞和系统负载，动态地调整云基础设施资源，
*   **以便于** 主动缓解网络拥塞，提高路由优化的收敛性和效率。
*   **业务规则与逻辑**:
    1.  `ElasticController` 监控由 `InfraInfoManager` 汇总的全局拥塞和性能指标（如平均虚拟队列长度）。
    2.  当指标超过预设阈值时，`ElasticController` 向 `ScalerWorker` 发出指令。
    3.  `ScalerWorker` 组件负责调用云服务商（如 AWS, VULTR）的 API，创建或销毁代理节点（VM）。
    4.  新增节点能自动注册到系统中，并被纳入全网状态同步。
*   **验收标准**:
    1.  系统能够成功调用云厂商 API 完成节点的创建和销毁。
    2.  在模拟的流量高峰场景下，系统能自动触发扩容，并在流量回落后自动缩容。

## 6. 非功能性需求
*   **性能需求**:
    *   路由决策API的响应时间应在 50ms 以内。
    *   代理节点的数据平面转发延迟应在 1ms 以内。
*   **可靠性需求**:
    *   系统应能容忍单个代理节点的故障，路由决策算法应能自动绕开失效节点。
    *   组长节点应有故障转移和手动切换机制。
*   **可配置性**:
    *   算法中的关键参数（如 `V_L`, `w_k^U`）应可通过配置文件进行调整。
    *   组长节点地址应可配置。

## 7. 待讨论/待明确事项
1.  **应用层协议定义**: 需要设计详细的、二进制优化的数据块头部格式和 Client-Proxy 之间的控制协议格式。
2.  **组长选举机制**: 当前为手动指定，未来版本可考虑引入基于分布式锁（如etcd）的自动选举机制。
3.  **弹性伸缩触发条件**: 需要量化定义触发弹性伸缩的具体阈值（例如，全网平均虚拟队列长度持续超过X达Y秒）。
4.  **安全模型**: 节点间的通信是否需要加密？Client 如何向代理节点进行身份验证？