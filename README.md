# åŠ¨æ€ TCP ä»£ç† (Dynamic TCP Proxy)

ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„åŠ¨æ€ TCP ä»£ç†æœåŠ¡å™¨ï¼Œå®ç°äº†å®Œå…¨åŸºäºè°ƒåº¦æŒ‡ä»¤çš„è·¯ç”±å†³ç­–ï¼Œæ”¯æŒä¸ Traffic Scheduler çš„å®æ—¶é€šä¿¡å’Œæ™ºèƒ½è·¯å¾„é€‰æ‹©ã€‚

## ğŸš€ é‡å¤§æ¶æ„å‡çº§

æœ¬é¡¹ç›®å·²å®Œæˆä»é™æ€è·¯ç”±åˆ°åŠ¨æ€è°ƒåº¦çš„é‡å¤§æ¶æ„é‡æ„ï¼Œç°åœ¨å®Œå…¨ç¬¦åˆ PRD ä¸­è½»é‡çº§ä»£ç†æ¨¡å—çš„è¦æ±‚ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ“¡ **åŠ¨æ€è°ƒåº¦è·¯ç”±**
- **è°ƒåº¦æŒ‡ä»¤é©±åŠ¨**ï¼šå®Œå…¨åŸºäº Traffic Scheduler çš„è°ƒåº¦æŒ‡ä»¤è¿›è¡Œè·¯ç”±å†³ç­–
- **å®æ—¶è·¯å¾„é€‰æ‹©**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µå’Œä¼˜åŒ–ç›®æ ‡åŠ¨æ€é€‰æ‹©æœ€ä¼˜è·¯å¾„
- **æ™ºèƒ½ç¼“å­˜**ï¼šæœ¬åœ°ç¼“å­˜è°ƒåº¦æŒ‡ä»¤ï¼Œæé«˜è·¯ç”±å†³ç­–æ€§èƒ½
- **å¤šè·¯å¾„æ”¯æŒ**ï¼šæ”¯æŒå•ä¸ªæµçš„å¤šè·¯å¾„ä¼ è¾“å’Œè´Ÿè½½å‡è¡¡

### ğŸ”„ **ç»Ÿä¸€ä»£ç†æ¨¡å‹**
- **å¯¹ç­‰èŠ‚ç‚¹**ï¼šæ¯ä¸ªä»£ç†èŠ‚ç‚¹åŠŸèƒ½ç›¸åŒï¼Œæ— å®¢æˆ·ç«¯/æœåŠ¡ç«¯åŒºåˆ†
- **åŒå‘è½¬å‘**ï¼šæ—¢å¯æ¥æ”¶è¿æ¥ï¼Œä¹Ÿå¯ä¸»åŠ¨å‘èµ·è¿æ¥
- **é€æ˜ä¸­ç»§**ï¼šä½œä¸ºä¸­é—´èŠ‚ç‚¹è½¬å‘æ•°æ®

### ğŸŒ **è°ƒåº¦å™¨é›†æˆ**
- **å®æ—¶é€šä¿¡**ï¼šä¸ Traffic Scheduler ä¿æŒæŒç»­è¿æ¥
- **çŠ¶æ€æŠ¥å‘Š**ï¼šå®šæœŸæŠ¥å‘Šæµé‡ç»Ÿè®¡å’ŒèŠ‚ç‚¹çŠ¶æ€
- **æŒ‡ä»¤è®¢é˜…**ï¼šè®¢é˜…è°ƒåº¦æ›´æ–°ï¼Œæ”¯æŒè·¯å¾„åŠ¨æ€è°ƒæ•´
- **æ•…éšœæ¢å¤**ï¼šè°ƒåº¦å™¨ä¸å¯ç”¨æ—¶çš„ä¼˜é›…é™çº§

## æ¶æ„è®¾è®¡

```
Traffic Scheduler (æ§åˆ¶å¹³é¢)
        â†“ è°ƒåº¦æŒ‡ä»¤
åº”ç”¨A â†â†’ ä»£ç†1 â†â†’ ä»£ç†2 â†â†’ åº”ç”¨B
        â†‘ çŠ¶æ€æŠ¥å‘Š
```

### æ ¸å¿ƒç»„ä»¶

- **åŠ¨æ€è·¯ç”±å¼•æ“ (DynamicRouteEngine)**ï¼šåŸºäºè°ƒåº¦æŒ‡ä»¤çš„æ™ºèƒ½è·¯ç”±å†³ç­–
- **è°ƒåº¦å™¨å®¢æˆ·ç«¯ (SchedulerClient)**ï¼šä¸ Traffic Scheduler çš„é€šä¿¡æ¥å£
- **æµç®¡ç†å™¨ (FlowManager)**ï¼šæ•°æ®æµç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œç»Ÿè®¡
- **æŒ‡ä»¤ç¼“å­˜ (InstructionCache)**ï¼šè°ƒåº¦æŒ‡ä»¤çš„æœ¬åœ°ç¼“å­˜å’Œæ›´æ–°
- **å¯¹ç­‰èŠ‚ç‚¹ç®¡ç†å™¨ (PeerManager)**ï¼šç®¡ç†å¯¹ç­‰èŠ‚ç‚¹è¿æ¥å’Œå¥åº·çŠ¶æ€

## é…ç½®æ ¼å¼

### åŠ¨æ€ä»£ç†é…ç½®ç¤ºä¾‹

```yaml
# é€šç”¨é…ç½®
common:
  log_level: "info"
  log_file: "dynamic-proxy.log"
  admin_addr: "127.0.0.1:8888"
  node_id: "proxy-node-1"
  region: "us-east"

# ç›‘å¬å™¨é…ç½®
listeners:
  - name: "web-listener"
    bind: "0.0.0.0:8080"
  - name: "api-listener"
    bind: "0.0.0.0:9090"

# è°ƒåº¦å™¨é…ç½®
scheduler:
  address: "127.0.0.1:9999"
  connect_timeout: "30s"
  request_timeout: "10s"
  retry_interval: "5s"
  max_retries: 3
  heartbeat_interval: "30s"

# å¯¹ç­‰èŠ‚ç‚¹é…ç½®ï¼ˆç”¨äºèŠ‚ç‚¹å‘ç°å’Œé€šä¿¡ï¼‰
peers:
  - name: "proxy-node-2"
    address: "192.168.1.50:9090"
    type: "tcp"
    region: "us-west"

  - name: "proxy-node-3"
    address: "192.168.1.51:9090"
    type: "tcp"
    region: "eu-central"
```

### é…ç½®è¯´æ˜

#### é€šç”¨é…ç½® (common)
- `node_id`: èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†ç¬¦
- `region`: èŠ‚ç‚¹æ‰€åœ¨åŒºåŸŸ
- `log_level`: æ—¥å¿—çº§åˆ«
- `log_file`: æ—¥å¿—æ–‡ä»¶è·¯å¾„

#### ç›‘å¬å™¨é…ç½® (listeners)
- `name`: ç›‘å¬å™¨åç§°
- `bind`: ç›‘å¬åœ°å€å’Œç«¯å£

#### è°ƒåº¦å™¨é…ç½® (scheduler)
- `address`: Traffic Scheduler åœ°å€
- `connect_timeout`: è¿æ¥è¶…æ—¶æ—¶é—´
- `request_timeout`: è¯·æ±‚è¶…æ—¶æ—¶é—´
- `retry_interval`: é‡è¯•é—´éš”
- `max_retries`: æœ€å¤§é‡è¯•æ¬¡æ•°
- `heartbeat_interval`: å¿ƒè·³é—´éš”

#### å¯¹ç­‰èŠ‚ç‚¹é…ç½® (peers)
- `name`: èŠ‚ç‚¹åç§°
- `address`: èŠ‚ç‚¹åœ°å€
- `type`: è¿æ¥ç±»å‹ï¼ˆé»˜è®¤ tcpï¼‰
- `region`: èŠ‚ç‚¹åŒºåŸŸ

## ä½¿ç”¨æ–¹æ³•

### ç¼–è¯‘

```bash
go build ./cmd/proxy
```

### è¿è¡Œ

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶
./proxy

# æŒ‡å®šé…ç½®æ–‡ä»¶
./proxy -c config.yaml
```

### æµ‹è¯•

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
go test ./internal/router -v
go test ./internal/peer -v

# è¿è¡Œé›†æˆæµ‹è¯•
go test ./test -v
```

## ä½¿ç”¨åœºæ™¯

### 1. è´Ÿè½½å‡è¡¡
```yaml
listeners:
  - name: "lb-listener"
    bind: "0.0.0.0:80"

routes:
  - name: "web-route"
    match:
      port: 80
    target: "backend-server:8080"
```

### 2. ä»£ç†é“¾
```yaml
# èŠ‚ç‚¹1é…ç½®
routes:
  - name: "chain-route"
    match:
      port: 8080
    target: "proxy-node-2"

peers:
  - name: "proxy-node-2"
    address: "192.168.1.50:9090"
```

### 3. æœåŠ¡ç½‘æ ¼
```yaml
# å¤šä¸ªç›‘å¬å™¨å’Œè·¯ç”±
listeners:
  - name: "service-a"
    bind: "0.0.0.0:8080"
  - name: "service-b"
    bind: "0.0.0.0:9090"

routes:
  - name: "route-a"
    match:
      port: 8080
    target: "service-a-backend:8080"
  - name: "route-b"
    match:
      port: 9090
    target: "service-b-backend:9090"
```

## API æ¥å£

### ç»Ÿè®¡ä¿¡æ¯
```go
stats := proxy.GetStats()
// è¿”å›ï¼šè¿æ¥æ•°ã€æµé‡ç»Ÿè®¡ã€èŠ‚ç‚¹ä¿¡æ¯ç­‰
```

### ç›‘å¬å™¨çŠ¶æ€
```go
listeners := proxy.GetListeners()
// è¿”å›ï¼šç›‘å¬å™¨åˆ—è¡¨å’ŒçŠ¶æ€
```

### å¯¹ç­‰èŠ‚ç‚¹çŠ¶æ€
```go
peers := proxy.GetPeers()
// è¿”å›ï¼šå¯¹ç­‰èŠ‚ç‚¹åˆ—è¡¨å’Œå¥åº·çŠ¶æ€
```

## æ€§èƒ½ç‰¹æ€§

- âœ… æ”¯æŒæ•°ç™¾ä¸ªå¹¶å‘è¿æ¥
- âœ… ä½å»¶è¿Ÿæ•°æ®è½¬å‘
- âœ… é«˜æ•ˆçš„å†…å­˜å’Œ CPU ä½¿ç”¨
- âœ… ä¼˜é›…çš„è¿æ¥å…³é—­
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—çº§åˆ«
- `debug`: è¯¦ç»†è°ƒè¯•ä¿¡æ¯
- `info`: ä¸€èˆ¬ä¿¡æ¯
- `warn`: è­¦å‘Šä¿¡æ¯
- `error`: é”™è¯¯ä¿¡æ¯
- `fatal`: è‡´å‘½é”™è¯¯

### ç»Ÿè®¡æŒ‡æ ‡
- å½“å‰è¿æ¥æ•°
- æ€»è¿æ¥æ•°
- å…¥ç«™/å‡ºç«™æµé‡
- èŠ‚ç‚¹å¥åº·çŠ¶æ€
- è·¯ç”±åŒ¹é…ç»Ÿè®¡

## å¼€å‘å’Œæ‰©å±•

### é¡¹ç›®ç»“æ„
```
â”œâ”€â”€ cmd/proxy/          # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ config/             # é…ç½®ç®¡ç†
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ proxy/          # ä»£ç†æ ¸å¿ƒ
â”‚   â”œâ”€â”€ router/         # è·¯ç”±å¼•æ“
â”‚   â”œâ”€â”€ peer/           # å¯¹ç­‰èŠ‚ç‚¹ç®¡ç†
â”‚   â”œâ”€â”€ listener/       # ç›‘å¬å™¨æŠ½è±¡
â”‚   â”œâ”€â”€ transport/      # ä¼ è¾“å±‚æŠ½è±¡
â”‚   â””â”€â”€ metrics/        # æŒ‡æ ‡æ”¶é›†
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ log/            # æ—¥å¿—ç³»ç»Ÿ
â”‚   â””â”€â”€ util/           # å·¥å…·å‡½æ•°
â””â”€â”€ test/               # æµ‹è¯•ç”¨ä¾‹
```

### æ‰©å±•ç‚¹
- æ”¯æŒæ›´å¤šä¼ è¾“åè®®ï¼ˆTLSã€UDPç­‰ï¼‰
- æ·»åŠ è®¤è¯å’Œæˆæƒæœºåˆ¶
- å®ç°é…ç½®çƒ­é‡è½½
- æ·»åŠ  Web ç®¡ç†ç•Œé¢
- æ”¯æŒæ’ä»¶ç³»ç»Ÿ

## è®¸å¯è¯

MIT License
